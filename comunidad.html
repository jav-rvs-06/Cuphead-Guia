<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Comunidad Cuphead</title>
  <meta name="description" content="Comunidad de Cuphead: espacio para compartir experiencias, trucos y comentarios sobre el juego.">
  <link href="cuphead-seeklogo.ico" rel="icon" type="image/png"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #ffcf0f;
      line-height: 1.6;
      padding: 20px;
      color: #000;
    }
    .wrap { max-width: 1000px; margin: 0 auto; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      min-height: 100px; padding: 0 20px; margin-bottom: 30px;
    }
    .logo { max-height: 80px; max-width: 250px; width: auto; object-fit: contain; }
    /* Agregando estilos para contenedor de botones en header */
    .header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .btn-back {
      background: linear-gradient(45deg, #FFD700, #FFA500); color: #8B4513; border: 2px solid #8B4513;
      padding: 12px 18px; border-radius: 25px; font-weight: bold; text-decoration: none;
      display: inline-block; cursor: pointer; transition: transform 0.15s;
    }
    .btn-back:hover { transform: translateY(-1px); }
    /* Agregando estilos para botón de cerrar sesión */
    .btn-logout {
      background: #fff; color: #8B4513; border: 2px solid #8B4513;
      padding: 12px 18px; border-radius: 25px; font-weight: bold;
      cursor: pointer; transition: transform 0.15s; font-size: 14px;
    }
    .btn-logout:hover { transform: translateY(-1px); background: #f5f5f5; }
    
    .panel {
      background: #fff; border-radius: 24px; padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;
    }
    h1 { font-size: 28px; margin-bottom: 10px; color: #8B4513; }
    .user-info { 
      font-size: 14px; color: #666; margin-bottom: 20px; 
      padding: 10px 15px; background: #f5f5f5; border-radius: 8px;
    }
    
    .form-section {
      margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px solid #eee;
    }
    .form-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #8B4513; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    .form-group input,
    .form-group textarea {
      width: 100%; padding: 10px 12px; border: 2px solid #8B4513; border-radius: 8px; 
      font-size: 14px; font-family: Arial, sans-serif;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-group input:focus,
    .form-group textarea:focus { outline: none; border-color: #FFD700; background: #fffef0; }
    
    .btn-submit {
      background: linear-gradient(45deg, #FFD700, #FFA500); color: #8B4513; border: 2px solid #8B4513;
      padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; 
      transition: transform 0.15s; font-size: 14px;
    }
    .btn-submit:hover { transform: translateY(-1px); }
    
    .msg { padding: 12px 15px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; }
    .msg.error { color: #8B0000; background: #ffe5e5; border: 1px solid #ffb3b3; }
    .msg.success { color: #1b5e20; background: #e8f5e9; border: 1px solid #c8e6c9; }
    .msg-hidden { display: none; }
    
    .comments-section { margin-top: 30px; }
    .comments-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #8B4513; }
    .comment {
      background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; padding: 15px;
      margin-bottom: 15px;
    }
    .comment-author { font-weight: bold; color: #8B4513; font-size: 14px; }
    .comment-date { font-size: 12px; color: #999; margin-top: 3px; }
    .comment-text { margin-top: 10px; font-size: 14px; line-height: 1.5; }
    
    .loading { text-align: center; padding: 20px; color: #666; }
    
    @media (max-width: 768px) {
      header { flex-direction: column; gap: 15px; text-align: center; }
      .header-buttons { flex-direction: column; width: 100%; }
      .btn-back, .btn-logout { width: 100%; }
      .panel { padding: 20px; }
      h1 { font-size: 24px; }
      .form-title { font-size: 16px; }
    }
  </style>
</head>
<body>
  <main>
    <div class="wrap">
      <header>
        <img alt="Cuphead Logo" class="logo" src="_img/CupheadLogo.png"/>
        <!-- Agregando contenedor de botones con cerrar sesión -->
        <div class="header-buttons">
          <a aria-label="Volver al inicio" class="btn-back" href="index.html">Volver al inicio</a>
          <button aria-label="Cerrar sesión" class="btn-logout" onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
      </header>
      
      <div class="panel">
        <h1>Comunidad Cuphead</h1>
        <div class="user-info" id="userInfo" style="display:none;">
          <!-- Mostrar usuario logueado -->
        </div>
        
        <div class="form-section">
          <div class="form-title">Comparte tu experiencia</div>
          <div id="formMsg" class="msg msg-hidden" role="alert" aria-live="polite"></div>
          
          <form id="commentForm" method="POST">
            <div class="form-group">
              <label for="commentPage">¿Sobre qué aspecto del juego quieres comentar?</label>
              <select id="commentPage" name="pagina" required style="width: 100%; padding: 10px 12px; border: 2px solid #8B4513; border-radius: 8px; font-size: 14px;">
                <option value="">Selecciona una página</option>
                <option value="personajes">Personajes</option>
                <option value="juego">El Juego</option>
                <option value="islas">Islas</option>
                <option value="isla1">Isla 1</option>
                <option value="isla2">Isla 2</option>
                <option value="isla3">Isla 3</option>
                <option value="jefes-finales">Jefes Finales</option>
                <option value="logros">Logros</option>
                <option value="secretos">Secretos</option>
                <option value="curso">Curso</option>
                <option value="dlc">DLC</option>
                <option value="desarrolladores">Desarrolladores</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="commentTitle">Título de tu comentario</label>
              <input id="commentTitle" name="titulo" type="text" placeholder="Ej: Mi mejor estrategia para King Dice" required/>
            </div>
            
            <div class="form-group">
              <label for="commentText">Tu comentario</label>
              <textarea id="commentText" name="contenido" placeholder="Escribe tu experiencia, trucos o preguntas..." required></textarea>
            </div>
            
            <button class="btn-submit" type="submit">Publicar comentario</button>
          </form>
        </div>
        
        <div class="comments-section">
          <div class="comments-title">Comentarios recientes</div>
          
          <!-- Agregar sistema de filtros por página -->
          <div style="margin-bottom: 20px;">
            <label for="pageFilter" style="display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px;">Filtrar por sección:</label>
            <select id="pageFilter" style="width: 100%; padding: 10px 12px; border: 2px solid #8B4513; border-radius: 8px; font-size: 14px;">
              <option value="">Todas las secciones</option>
              <option value="personajes">Personajes</option>
              <option value="juego">El Juego</option>
              <option value="islas">Islas</option>
              <option value="isla1">Isla 1</option>
              <option value="isla2">Isla 2</option>
              <option value="isla3">Isla 3</option>
              <option value="jefes-finales">Jefes Finales</option>
              <option value="logros">Logros</option>
              <option value="secretos">Secretos</option>
              <option value="curso">Curso</option>
              <option value="dlc">DLC</option>
              <option value="desarrolladores">Desarrolladores</option>
            </select>
          </div>
          
          <div id="commentsList" class="loading">Cargando comentarios...</div>
        </div>
      </div>
    </div>
  </main>
  
  <footer style="text-align: center; margin-top: 40px; padding: 20px; color: #8B4513;">
    © 2025 Guía Cuphead - Todos los derechos reservados
  </footer>

  <script>
    // Verificar si el usuario está logueado
    function checkUserSession() {
      fetch('BD/check-session.php')
        .then(res => res.json())
        .then(data => {
          if (data.logueado) {
            document.getElementById('userInfo').textContent = 'Has accedido como: ' + data.usuario;
            document.getElementById('userInfo').style.display = 'block';
          } else {
            window.location.href = 'index.html';
          }
        })
        .catch(() => window.location.href = 'index.html');
    }

    function cerrarSesion() {
      if (confirm('¿Estás seguro que deseas cerrar sesión?')) {
        window.location.href = 'BD/logout.php';
      }
    }

    function loadComments() {
      const filtro = document.getElementById('pageFilter').value;
      const url = filtro ? `BD/get-comments.php?pagina=${encodeURIComponent(filtro)}` : 'BD/get-comments.php';
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('commentsList');
          
          if (!data.comentarios || data.comentarios.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: #999;">No hay comentarios en esta sección. ¡Sé el primero!</p>';
            return;
          }

          list.innerHTML = data.comentarios.map(c => `
            <div class="comment">
              <div class="comment-author">${c.nombre_usuario} en ${c.pagina}</div>
              <div class="comment-date">${new Date(c.fecha_comentario).toLocaleDateString('es-ES', {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</div>
              <div style="font-weight: bold; margin-top: 8px;">${c.titulo}</div>
              <div class="comment-text">${c.contenido}</div>
            </div>
          `).join('');
        })
        .catch(err => {
          document.getElementById('commentsList').innerHTML = '<p style="color: #d32f2f;">Error al cargar comentarios</p>';
        });
    }

    document.getElementById('pageFilter').addEventListener('change', loadComments);

    // Enviar formulario
    document.getElementById('commentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const msg = document.getElementById('formMsg');

      fetch('BD/add-comment.php', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        msg.classList.remove('msg-hidden');
        if (data.success) {
          msg.className = 'msg success';
          msg.textContent = '✓ Comentario publicado correctamente';
          document.getElementById('commentForm').reset();
          setTimeout(loadComments, 500);
        } else {
          msg.className = 'msg error';
          msg.textContent = '✗ ' + (data.error || 'Error al publicar');
        }
      })
      .catch(() => {
        msg.className = 'msg error';
        msg.textContent = '✗ Error de conexión';
        msg.classList.remove('msg-hidden');
      });
    });

    // Inicializar
    checkUserSession();
    loadComments();
    setInterval(loadComments, 5000);
  </script>
</body>
</html>
